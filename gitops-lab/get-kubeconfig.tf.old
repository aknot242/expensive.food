data http kubeconfig {
    method = "POST"
    url = format("https://%s.console.ves.volterra.io/api/web/namespaces/system/sites/%s/global-kubeconfigs",var.xc_tenant,var.xc_site_name)
    request_headers = {
        Accept = "application/json"
        Authorization = format("APIToken %s", var.VOLTERRA_TOKEN)
    }
    request_body = jsonencode(local.requestbody)
}
locals {
    requestbody = {
        expiration_timestamp = timeadd(timestamp(), "720h") # 30 days
        site = var.xc_site_name
    }
}
variable kubeconfig_location {
  type = string
  default = "~/.kube/config"
}
output kubeconfig {
    value  = data.http.kubeconfig.response_body
}
output kubeconfig_context {
  value = yamldecode(data.http.cloud_accounts.response_body).current-context
}
resource local_file kubeconfig {
    count    = data.http.cloud_accounts.status_code == 200 ? 1 : 0
    filename = var.kubeconfig_location
    content  = data.http.cloud_accounts.response_body
}

output kubeconfig_location {
  value = var.kubeconfig_location
}